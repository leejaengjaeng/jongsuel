<!DOCTYPE html>
<!--
    Interphase by TEMPLATED
    templated.co @templatedco
    Released for free under the Creative Commons Attribution 3.0 license(templated.co / license)
-->
                                                
<html lang = "en">
<head>
    <meta charset = "UTF-8">
    <title>PERS</title>
    <meta http - equiv = "content-type" content = "text/html; charset=utf-8"/>
    <meta name = "description" content = ""/>
    <meta name = "keywords" content = ""/>
    <script src = "javascripts/jquery.min.js"></script>
    <script src = "javascripts/skel.min.js"></script>
    <script src = "javascripts/skel-layers.min.js"></script>
    <script src = "javascripts/init.js"></script>
    <!--noscript-->
    <link rel = "stylesheet" type = "text/css" href = "css/skel.css"/>
    <link rel = "stylesheet" type = "text/css" href = "css/style.css"/>
    <link rel = "stylesheet" type = "text/css" href = "css/style-xlarge.css"/>
    <!--/noscript-->
</head>
<body class = "landing">
<script>
// init facebookAPI
window.fbAsyncInit = function() {    
    FB.init({
          appId: '1402535423379425',
          cookie : true,  // enable cookies to allow the server to access 
          // the session
          xfbml : true,  // parse social plugins on this page
          version : 'v2.6' // use version 2.6
    });
};
// Load the SDK asynchronously
(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "http://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

//Login check 
var myAToken = "";
var userid = "";
function check(response,flag)
{
        if (response.status === 'connected')
        {
            myAToken = response.authResponse.accessToken;
            userid = response.authResponse.userID;
            // document.getElementById('showID').innerHTML="userID : "+userid;
            console.log("userID : " + userid + "\n");
            testShow(myAToken,userid,flag);
        }
        else if (response.status === 'not_authorized')
        {
            FB.login(function(response)
                    {
                        myAToken = response.authResponse.accessToken;
                        userid = response.authResponse.userID;
                        // document.getElementById('showID').innerHTML="userID : "+userid;
                        console.log("userID : " + userid + "\n");
                        testShow(myAToken,userid,flag);
                    }, { scope: 'public_profile,email,user_posts' });
        }
        else
        {
            FB.login(function(response)
                    {
                        myAToken = response.authResponse.accessToken;
                        userid = response.authResponse.userID;
                        // document.getElementById('showID').innerHTML="userID : "+userid;           
                        console.log("userID : " + userid + "\n");
                        testShow(myAToken,userid,flag);

                    }, { scope: 'public_profile,email,user_posts' });
        }
}
//time Setting for get feed
//..? 여기에 넣으면 근데 하루에 한번씩 서버 다시 켜야되나 
  var today = new Date();
    var dd = today.getDate();
    var mm = today.getMonth()+1; //January is 0!
    var yyyy = today.getFullYear();
    if(dd<10) {
            dd='0'+dd
    } 
    if(mm<10) {
            mm='0'+mm
    } 
    today = yyyy+'-'+mm+'-'+dd;
    
    var yesterDay = new Date(dd+'/'+mm+'/'+yyyy);
    var dayOfMonth = yesterDay.getDate();
    yesterDay.setDate(ydd-1);
    var ydd = yesterDay.getDate();
    var ymm = yesterDay.getMonth()+1;
    var yyyyy = yesterDay.getFullYear();
    if(ydd<10) {
            ydd='0'+ydd
    } 
    if(ymm<10) {
            ymm='0'+ymm
    } 
    yesterDay = yyyyy+'-'+ymm+'-'+ydd;

    //편의를 위해 4달(약 120일 로 설정)
    var before100Days = new Date(dd+'/'+mm+'/'+yyyy);
    var monthOfYear = before100Days.getMonth();
    before100Days.setMonth(monthOfYear-4);
    var dd100 = before100Days.getDate();
    var mm100 = before100Days.getMonth();
    var yy100 = before100Days.getFullYear();
    if(dd100<10) {
            dd100='0'+dd100
    } 
    if(mm100<10) {    
        mm100='0'+mm100
    } 
   before100Days = yy100+'-'+mm100+'-'+dd100;
   

//show user's feed
function testShow(myAToken,userid,flag)
{
   
    var energy = 84;
    var emotion = 2;
    var uid = userid;
     
    //&since=2011-07-01&until=2012-08-08&access_token=ACCESSTOKEN&limit=100
    if(flag==1)//전체 피드
    {
        FB.api('/me/feed?access_token=' + myAToken + '&limit=300', function(response)
        {
           var messageBox = new Array();
            messageBox[0] = "message";
            var texts = JSON.stringify(response.data, messageBox, '\t');
            // document.getElementById('showJson').innerHTML=texts;
            var getImg = new Promise(function(resolve,reject){
               FB.api('/me/picture?type=large',function(response)
               {
                  var imgUrl = response.data.url;
                  resolve(imgUrl);
               });
            });
            var getUname = new Promise(function(resolve,reject){
                 FB.api('/me',{locale : 'ko_KR'},function(response)
                 {
                    var uname = response.name;
                    resolve(uname);
                 });
            });
            var args = ['http://ec2-52-79-93-55.ap-northeast-2.compute.amazonaws.com:8100/server',{'userid':uid,'energy':energy,'emotion':emotion,'messages':texts}]
            Promise.all([getImg,getUname,args]).then(post_to_url);      
            FB.logout();
            alert('전체 피드 전송되었습니다');
        });
    }
    else if(flag==0)//오늘 피드
    {
        FB.api('/me/feed?access_token=' + myAToken + '&since='+yesterDay+'&until='+today+'&limit=300', function(response)
        {
           var messageBox = new Array();
            messageBox[0] = "message";
            var texts = JSON.stringify(response.data, messageBox, '\t');
            // document.getElementById('showJson').innerHTML=texts;
            var getImg = new Promise(function(resolve,reject){
               FB.api('/me/picture?type=large',function(response)
               {
                  var imgUrl = response.data.url;
                  resolve(imgUrl);
               });
            });
            var getUname = new Promise(function(resolve,reject){
                 FB.api('/me',{locale : 'ko_KR'},function(response)
                 {
                    var uname = response.name;
                    resolve(uname);
                 });
            });
            var args = ['http://ec2-52-79-93-55.ap-northeast-2.compute.amazonaws.com:8100/server',{'userid':uid,'energy':energy,'emotion':emotion,'messages':texts,'date':today}]
            Promise.all([getImg,getUname,args]).then(post_to_url);      
            FB.logout();
            alert('오늘 피드 전송되었습니다');
        });
    } 
    else if(flag==2)//100일(4달치) 피드
    {
        FB.api('/me/feed?access_token=' + myAToken + '&since='+before100Days+'&until='+today+'&limit=300', function(response)
        {
            var messageBox = new Array();
            messageBox[0] = "message";
            var texts = JSON.stringify(response.data, messageBox, '\t');
            // document.getElementById('showJson').innerHTML=texts;
            var getImg = new Promise(function(resolve,reject){
               FB.api('/me/picture?type=large',function(response)
               {
                  var imgUrl = response.data.url;
                  resolve(imgUrl);
               });
            });
            var getUname = new Promise(function(resolve,reject){
                 FB.api('/me',{locale : 'ko_KR'},function(response)
                 {
                    var uname = response.name;
                    resolve(uname);
                 });
            });
            var args = ['http://ec2-52-79-93-55.ap-northeast-2.compute.amazonaws.com:8100/server',{'userid':uid,'energy':energy,'emotion':emotion,'messages':texts}]
            Promise.all([getImg,getUname,args]).then(post_to_url);      
            FB.logout();
            alert('최근 피드 전송되었습니다');
        });
    }
    else
   {
        console.log('0:오늘피드, 1:모든피드, 2:100일치(4달치) 피드');
   }
}

///// url,name을 어떻게 꺼낼지 모르겠다
function getImageTest(myAToken,userid,response)
{
    var url={};
    FB.api('/me/picture?type=large',function(response)
    {
        url.path = response.data.url;
        document.getElementById("fbImage").innerHTML += "<img src="+url+"><br>";
    });
    var returnPath = function(url){return url.path;};
            
    setTimeout(returnPath(url),5000);
}
function getMyName(myAToken,userid,response)
{
    var name;
    FB.api('/me',{locale : 'ko_KR'},function(response)
    {
        name = response.name;
    });

    return name;
}

//Facebook Login
//flag) 0: 오늘의 피드 가져오기, 1: 모든 피드 가져오기, 2: 100일치 피드 가져오기
function customLoginF(flag)
{
   FB.getLoginStatus(function(response)
   {
        check(response,flag);
   });
}


/*
* path : 전송 URL
* params : 전송 데이터 {'q':'a','s':'b','c':'d'...}으로 묶어서 배열 입력
* method : 전송 방식(생략가능)
*/

function post_to_url(input) 
{
     var form = document.createElement("form");
     form.setAttribute("method", "post");
     form.setAttribute("action", input[2][0]);
     var params = input[2][1];
     for(var key in params) 
     {
        var hiddenField = document.createElement("input");
        hiddenField.setAttribute("type", "hidden");
        hiddenField.setAttribute("name", key);
        hiddenField.setAttribute("value", params[key]);
        form.appendChild(hiddenField);
     }
     var hiddenField = document.createElement("input");
     hiddenField.setAttribute("type", "hidden");
     hiddenField.setAttribute("name", "imgUrl");
     hiddenField.setAttribute("value", input[0]);
     form.appendChild(hiddenField);

     var hiddenField = document.createElement("input");
     hiddenField.setAttribute("type", "hidden");
     hiddenField.setAttribute("name", "uname");
     hiddenField.setAttribute("value", input[1]);
     form.appendChild(hiddenField);
     
     document.body.appendChild(form);
     form.submit();
}

/*
    실제로 구동시킬 때 입력 예제
    post_to_url('http://example.com/', {'q':'a'});
*/

</script>





<!--Header-->

<header id = "header">
<h1><a href = "index.html">P.E.R.S</a></h1>
<nav id = "nav">
<ul>
    <li><a onclick="customLoginF(1)">(테스트) 모든피드</a></li>
    <li><a onclick="customLoginF(2)">처음 방문</a></li> 
</ul>
</nav>
</header>

<!--Banner-->
<section id = "banner">
<h2>오늘의 상태는 어떠세요 ? </h2>
<br>

<h2>★★★★★★☆☆☆</h2>
<ul class = "actions">
<li>
<img src = "images/veryBad.png" onclick = "" style = "width:130px">
</li>
<li>
<img src = "images/bad.png" style = "width:130px">
</li>
<li>
<img  src = "images/soso.png"  style = "width:130px">
</li>
<li>
<img  src = "images/good.png" style = "width:130px">
</li>
<li>
<img src = "images/veryGood.png" style = "width:130px">
</li>
</ul>
<br><br><br>
<input type = "IMAGE" src = "images/facebookLogin.png" onclick = "customLoginF(0)" style = "width:300px">
<div id="fbImage"></div>
</section>

<!--One-->
<section id = "one" class = "wrapper style1 align-center">
<div class = "container">
<header>
<h2>오늘의 기분은 어떠세요 ? </h2>
<p>기분과 에너지 상태를 표시하고 페이스북으로 로그인하세요.</p>
<p>감정분석을 통해 상담사 선생님과 상담할 타이밍을 알려줍니다.</p>
</header>
<div class = "row 200%">
<section class = "4u 12u$(small)">
<i class = "icon big rounded fa-clock-o"></i>
<p>타이밍을 놓치지 마세요. </p>
</section>
<section class = "4u 12u$(small)">
<i class = "icon big rounded fa-comments"></i>
<p>집단속에서 외로운 누군가를 찾아줍니다.</p>
</section>
<section class = "4u$ 12u$(small)">
<i class = "icon big rounded fa-user"></i>
<p>상담사 선생님이 연락을 할거에요!</p>
</section>
</div>
</div>
</section>


<!--Footer-->
<footer id = "footer">
<div class = "container">
<ul class = "copyright">
<li>&copy; Untitled.All rights reserved.</li>
<li>Design: <a href = "http://templated.co">TEMPLATED</a></li>
<li>Images : <a href = "http://unsplash.com">Unsplash</a></li>
</ul>
</div>
</footer>

</body>
</html>
